generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ItemType {
  MATERIAL
  SERVICE
}

enum ExpenseType {
  MATERIAL
  LABOUR
  SUBCONTRACTOR
  OVERHEAD
}

enum GstType {
  INTRA
  INTER
}

enum LedgerAccountType {
  ASSET
  LIABILITY
  INCOME
  EXPENSE
  EQUITY
}

enum VoucherType {
  PURCHASE
  SALE
  PAYMENT
  RECEIPT
  JOURNAL
}

enum PaymentMode {
  CASH
  BANK_TRANSFER
  CHEQUE
  UPI
  CARD
  OTHER
}

enum VendorLegalType {
  INDIVIDUAL
  HUF
  FIRM
  COMPANY
  OTHER
}

enum AttachmentEntityType {
  EXPENSE
  PURCHASE_INVOICE
  INVOICE
  PAYMENT_VOUCHER
  LABOUR_PAYMENT
  TRANSACTION
  TENANT_PROFILE
}

enum StockDirection {
  IN
  OUT
}

enum StockReferenceType {
  PURCHASE_INVOICE
  EXPENSE
  ADJUSTMENT
  ISSUE
  RETURN
}

enum PayeeType {
  VENDOR
  LABOURER
  OTHER
}

enum FinanceAccountType {
  CASH
  BANK
  UPI
  CARD
  OTHER
}

enum TransactionDirection {
  IN
  OUT
  TRANSFER
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIAL
  PAID
  CANCELLED
}

model ProjectPaymentStage {
  id        String @id @default(cuid())
  tenantId  Int    @default(1)
  projectId String

  stageName   String
  scopeOfWork String?
  percent     Decimal? @db.Decimal(5, 2)

  expectedAmount Decimal @db.Decimal(14, 2)
  expectedBank   Decimal @default(0) @db.Decimal(14, 2)
  expectedCash   Decimal @default(0) @db.Decimal(14, 2)

  actualBank Decimal @default(0) @db.Decimal(14, 2)
  actualCash Decimal @default(0) @db.Decimal(14, 2)

  expectedDate DateTime? @db.Date
  actualDate   DateTime? @db.Date

  notes     String?
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, projectId, sortOrder])
  @@index([tenantId, projectId, stageName])
}

model Tenant {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                User[]
  clients              Client[]
  vendors              Vendor[]
  projects             Project[]
  items                Item[]
  expenses             Expense[]
  purchaseInvoices     PurchaseInvoice[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  invoices             Invoice[]
  vendorPayments       VendorPayment[]
  ledgerAccounts       LedgerAccount[]
  ledgerEntries        LedgerEntry[]
  stockMovements       StockMovement[]
  labourers            Labourer[]
  paymentVouchers      PaymentVoucher[]
  attachments          Attachment[]
  financeAccounts      FinanceAccount[]
  txnCategories        TxnCategory[]
  transactions         Transaction[]
  projectPaymentStages ProjectPaymentStage[]
  profile              TenantProfile?
  allocations          Allocation[]
}

model TenantProfile {
  id       String @id @default(cuid())
  tenantId Int    @unique @default(1)

  legalName   String
  tradeName   String?
  phone       String?
  email       String?
  address     String?
  gstin       String?
  pan         String?

  bankName      String?
  bankAccountNo String?
  bankIfsc      String?
  upiId         String?

  logoUrl      String?
  logoName     String?
  logoMimeType String?
  logoSize     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, gstin])
}

// --- Auth (NextAuth / Auth.js) ---
model User {
  id            String    @id @default(cuid())
  tenantId      Int       @default(1)
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(STAFF)
  passwordHash  String?

  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  attachments Attachment[]

  @@index([tenantId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- Masters ---
model Client {
  id             String  @id @default(cuid())
  tenantId       Int     @default(1)
  name           String
  contactPerson  String?
  phone          String?
  email          String?
  billingAddress String?
  gstin          String?
  pan            String?

  ledgerAccountId String?        @unique
  ledgerAccount   LedgerAccount? @relation(fields: [ledgerAccountId], references: [id], onDelete: SetNull)

  projects       Project[]
  invoices       Invoice[]
  transactions   Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, gstin])
}

model Vendor {
  id              String          @id @default(cuid())
  tenantId        Int             @default(1)
  name            String
  trade           String?
  legalType       VendorLegalType @default(OTHER)
  gstin           String?
  pan             String?
  phone           String?
  email           String?
  address         String?
  isSubcontractor Boolean         @default(false)

  ledgerAccountId String?        @unique
  ledgerAccount   LedgerAccount? @relation(fields: [ledgerAccountId], references: [id], onDelete: SetNull)

  expenses         Expense[]
  purchaseInvoices PurchaseInvoice[]
  vendorPayments   VendorPayment[]
  transactions     Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  paymentVouchers PaymentVoucher[]

  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, trade])
  @@index([tenantId, gstin])
}

model Project {
  id        String        @id @default(cuid())
  tenantId  Int           @default(1)
  name      String
  clientId  String
  location  String?
  startDate DateTime?     @db.Date
  endDate   DateTime?     @db.Date
  status    ProjectStatus @default(ACTIVE)
  remarks   String?

  client Client @relation(fields: [clientId], references: [id], onDelete: Restrict)

  expenses             Expense[]
  purchaseInvoices     PurchaseInvoice[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  invoices             Invoice[]
  ledgerEntries        LedgerEntry[]
  transactions         Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  stockMovements  StockMovement[]
  paymentVouchers PaymentVoucher[]
  attachments     Attachment[]
  paymentStages   ProjectPaymentStage[]

  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, clientId])
  @@index([tenantId, status])
}

model Item {
  id         String   @id @default(cuid())
  tenantId   Int      @default(1)
  name       String
  type       ItemType
  unit       String?
  sacHsnCode String?
  gstRate    Decimal  @db.Decimal(5, 2)

  purchaseInvoiceLines PurchaseInvoiceLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  stockMovements StockMovement[]

  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, type])
}

// --- Transactions ---
model Expense {
  id       String @id @default(cuid())
  tenantId Int    @default(1)

  projectId String
  vendorId  String

  category ExpenseType

  billNo   String?
  billDate DateTime  @db.Date
  dueDate  DateTime? @db.Date

  subtotal Decimal @db.Decimal(14, 2)
  cgst     Decimal @default(0) @db.Decimal(14, 2)
  sgst     Decimal @default(0) @db.Decimal(14, 2)
  igst     Decimal @default(0) @db.Decimal(14, 2)
  total    Decimal @db.Decimal(14, 2)

  narration String?

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Restrict)
  vendor      Vendor      @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  allocations Allocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, projectId, billDate])
  @@index([tenantId, vendorId, billDate])
  @@index([tenantId, category])
}

model Labourer {
  id       String  @id @default(cuid())
  tenantId Int     @default(1)
  name     String
  phone    String?
  address  String?
  active   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  paymentVouchers PaymentVoucher[]

  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, active])
}

model StockMovement {
  id            String             @id @default(cuid())
  tenantId      Int                @default(1)
  projectId     String
  itemId        String
  date          DateTime           @db.Date
  direction     StockDirection
  quantity      Decimal            @db.Decimal(14, 3)
  unitCost      Decimal?           @db.Decimal(14, 2)
  referenceType StockReferenceType
  referenceId   String?
  remarks       String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Restrict)
  item    Item    @relation(fields: [itemId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, projectId, date])
  @@index([tenantId, itemId, date])
  @@index([tenantId, referenceType, referenceId])
}

model PaymentVoucher {
  id          String      @id @default(cuid())
  tenantId    Int         @default(1)
  payeeType   PayeeType
  vendorId    String?
  labourerId  String?
  payeeName   String?
  projectId   String?
  date        DateTime    @db.Date
  mode        PaymentMode
  reference   String?
  grossAmount Decimal     @db.Decimal(14, 2)
  tdsSection  String?
  tdsRate     Decimal?    @db.Decimal(5, 2)
  tdsAmount   Decimal?    @db.Decimal(14, 2)
  netPaid     Decimal     @db.Decimal(14, 2)
  narration   String?

  vendor   Vendor?   @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  labourer Labourer? @relation(fields: [labourerId], references: [id], onDelete: SetNull)
  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, payeeType, date])
  @@index([tenantId, vendorId, date])
  @@index([tenantId, labourerId, date])
  @@index([tenantId, projectId, date])
}

model Attachment {
  id         String               @id @default(cuid())
  tenantId   Int                  @default(1)
  entityType AttachmentEntityType
  entityId   String
  projectId  String?

  originalName String
  mimeType     String
  size         Int
  storagePath  String

  uploadedById String?
  uploadedBy   User?   @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, projectId, createdAt])
}

model FinanceAccount {
  id       String             @id @default(cuid())
  tenantId Int                @default(1)
  name     String
  type     FinanceAccountType
  active   Boolean            @default(true)

  outgoingTransactions Transaction[] @relation("TxnFromAccount")
  incomingTransactions Transaction[] @relation("TxnToAccount")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, active])
}

model TxnCategory {
  id       String          @id @default(cuid())
  tenantId Int             @default(1)
  name     String
  direction TransactionDirection
  active   Boolean         @default(true)

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, direction, name])
  @@index([tenantId])
  @@index([tenantId, direction])
  @@index([tenantId, active])
}

model Transaction {
  id       String @id @default(cuid())
  tenantId Int    @default(1)

  /// Source of truth for money movement:
  /// - direction IN: money received (cash/bank) into an account
  /// - direction OUT: money paid out (cash/bank) from an account
  /// - amount = actual cash/bank moved
  /// - tdsAmount = tax deducted at source associated with this transaction
  ///   (for IN: client deducted TDS; for OUT: vendor TDS withheld)
  /// - applied/settled amount for documents is typically (amount + tdsAmount)
  direction TransactionDirection
  date      DateTime @db.Date
  amount    Decimal  @db.Decimal(14, 2)
  tdsAmount Decimal  @default(0) @db.Decimal(14, 2)

  mode      PaymentMode
  reference String?

  projectId  String?
  clientId   String?
  vendorId   String?
  categoryId String?

  fromAccountId String?
  toAccountId   String?

  note        String?
  description String?

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  client  Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  vendor  Vendor?  @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  category    TxnCategory?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  fromAccount FinanceAccount? @relation("TxnFromAccount", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccount   FinanceAccount? @relation("TxnToAccount", fields: [toAccountId], references: [id], onDelete: SetNull)

  allocations Allocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([tenantId, direction, date])
  @@index([tenantId, projectId, date])
  @@index([tenantId, clientId, date])
  @@index([tenantId, vendorId, date])
  @@index([tenantId, mode, date])
  @@index([tenantId, fromAccountId, date])
  @@index([tenantId, toAccountId, date])
  @@index([tenantId, categoryId, date])
}

model Allocation {
  id        String @id @default(cuid())
  tenantId  Int    @default(1)

  transactionId String

  /// Exactly one of invoiceId / expenseId should be set.
  invoiceId String?
  expenseId String?

  /// Amount applied to the document (cash/bank moved).
  cashAmount Decimal @db.Decimal(14, 2)
  /// Portion of Transaction.tdsAmount applied to this document (0 by default).
  tdsAmount  Decimal @default(0) @db.Decimal(14, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  invoice     Invoice?    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  expense     Expense?    @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, transactionId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, expenseId])
}

model PurchaseInvoice {
  id            String   @id @default(cuid())
  tenantId      Int      @default(1)
  vendorId      String
  invoiceNumber String
  invoiceDate   DateTime @db.Date
  projectId     String
  gstType       GstType

  taxableValue Decimal @db.Decimal(14, 2)
  cgst         Decimal @default(0) @db.Decimal(14, 2)
  sgst         Decimal @default(0) @db.Decimal(14, 2)
  igst         Decimal @default(0) @db.Decimal(14, 2)
  total        Decimal @db.Decimal(14, 2)

  tdsApplicable Boolean  @default(false)
  tdsSection    String?
  tdsRate       Decimal? @db.Decimal(5, 2)
  tdsAmount     Decimal? @db.Decimal(14, 2)
  netPayable    Decimal? @db.Decimal(14, 2)

  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  project Project @relation(fields: [projectId], references: [id], onDelete: Restrict)

  lines    PurchaseInvoiceLine[]
  payments VendorPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, vendorId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, vendorId, invoiceDate])
  @@index([tenantId, projectId, invoiceDate])
}

model PurchaseInvoiceLine {
  id                String  @id @default(cuid())
  tenantId          Int     @default(1)
  purchaseInvoiceId String
  itemId            String
  quantity          Decimal @db.Decimal(14, 3)
  rate              Decimal @db.Decimal(14, 2)
  amount            Decimal @db.Decimal(14, 2)
  projectId         String

  purchaseInvoice PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  item            Item            @relation(fields: [itemId], references: [id], onDelete: Restrict)
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, purchaseInvoiceId])
  @@index([tenantId, projectId])
}

model Invoice {
  id                   String    @id @default(cuid())
  tenantId             Int       @default(1)
  clientId             String
  projectId            String
  invoiceNo            String
  invoiceDate          DateTime  @db.Date
  dueDate              DateTime? @db.Date
  serviceDescription   String?
  sacCode              String?
  gstRate              Decimal?  @db.Decimal(5, 2)
  subtotal             Decimal   @db.Decimal(14, 2)
  gstType              GstType
  cgst                 Decimal   @default(0) @db.Decimal(14, 2)
  sgst                 Decimal   @default(0) @db.Decimal(14, 2)
  igst                 Decimal   @default(0) @db.Decimal(14, 2)
  total                Decimal   @db.Decimal(14, 2)
  tdsRate              Decimal?  @db.Decimal(5, 2)
  tdsAmountExpected    Decimal?  @db.Decimal(14, 2)
  tdsCertificateNumber String?
  status               InvoiceStatus @default(ISSUED)
  notes                String?

  client  Client  @relation(fields: [clientId], references: [id], onDelete: Restrict)
  project Project @relation(fields: [projectId], references: [id], onDelete: Restrict)

  allocations Allocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, projectId, invoiceNo])
  @@index([tenantId])
  @@index([tenantId, clientId, invoiceDate])
  @@index([tenantId, projectId, invoiceDate])
  @@index([tenantId, status])
}

model VendorPayment {
  id                String      @id @default(cuid())
  tenantId          Int         @default(1)
  vendorId          String
  purchaseInvoiceId String?
  date              DateTime    @db.Date
  amountPaid        Decimal     @db.Decimal(14, 2)
  mode              PaymentMode
  reference         String?
  tdsDeducted       Boolean     @default(false)
  tdsAmount         Decimal?    @db.Decimal(14, 2)
  remarks           String?

  vendor          Vendor           @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  purchaseInvoice PurchaseInvoice? @relation(fields: [purchaseInvoiceId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, vendorId, date])
  @@index([tenantId, purchaseInvoiceId])
}

// --- Accounting ---
model LedgerAccount {
  id       String            @id @default(cuid())
  tenantId Int               @default(1)
  name     String
  type     LedgerAccountType
  group    String?

  clients Client[]
  vendors Vendor[]

  debitEntries  LedgerEntry[] @relation("LedgerDebit")
  creditEntries LedgerEntry[] @relation("LedgerCredit")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, type])
}

model LedgerEntry {
  id              String      @id @default(cuid())
  tenantId        Int         @default(1)
  date            DateTime    @db.Date
  voucherType     VoucherType
  voucherId       String
  debitAccountId  String
  creditAccountId String
  amount          Decimal     @db.Decimal(14, 2)
  narration       String?
  projectId       String?

  debitAccount  LedgerAccount @relation("LedgerDebit", fields: [debitAccountId], references: [id], onDelete: Restrict)
  creditAccount LedgerAccount @relation("LedgerCredit", fields: [creditAccountId], references: [id], onDelete: Restrict)
  project       Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([tenantId, voucherType, voucherId])
  @@index([tenantId, projectId, date])
}
